{% extends settings.theme ~ "/layout.html" %}

{% block title %}Index{% endblock %}

{% set nbPosts = 0 %}

{% block content %}
	{% for article in articles %}
		{% if article.author == settings.author %}
			{% if 'This is a cross post' not in article.body or 'This is a cross post' in article.body and settings.crosspost == true %}
			
				{% set nbPosts = nbPosts + 1 %}
				
				{% if nbPosts == 1 %}
					<article class="flex h-full bg-white rounded overflow-hidden shadow-lg" data-image="{{ article.body|striptags }}">
						<a href="{{ url_for('post', { 'permlink': article.permlink }) }}" class="flex flex-wrap no-underline hover:no-underline">
							<div class="w-full md:w-2/3 rounded-t">	
								<img src="" class="img-article h-full w-full shadow">
							</div>

							<div class="w-full md:w-1/3 flex flex-col flex-grow flex-shrink">
								<div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg">
									<p class="w-full text-gray-600 text-xs md:text-sm pt-6 px-6">{{ article.created|date("m/d/Y") }}</p>
									<h2 class="w-full font-bold text-xl text-gray-900 px-6">{{ article.title }}</h2>
									{% set excerpt = article.body|striptags|slice(0,450) %}
									<p class="excerpt text-gray-800 font-serif text-base px-6 mt-1 mb-5">{{ excerpt }}...</p>
								</div>

								<div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6">
									<div class="flex items-center justify-between">
										<p class="text-gray-500 text-xs md:text-sm">{{article.active_votes|length}} Upvotes - {{article.body|split(' ')|length }} Words</p>
									</div>
								</div>
							</div>

						</a>
					</article>
				{% else %}
				{% if nbPosts == 2 %}<div class="flex flex-wrap justify-between pt-12 -mx-6">{% endif %}
					<article data-image="{{ article.body|striptags }}" class="w-full md:w-1/3 p-6 flex flex-col flex-grow flex-shrink">
						<div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg">
							<a href="{{ url_for('post', { 'permlink': article.permlink }) }}" class="flex flex-wrap no-underline hover:no-underline">
								<div class="w-full text-center mt-1">
									<img src="" class="img-article inline h-64 rounded-t pb-6">
								</div>
								<p class="w-full text-gray-600 text-xs md:text-sm px-6">{{ article.created|date("m/d/Y") }}</p>
								<h2 class="w-full font-bold text-xl text-gray-900 px-6">{{ article.title }}</h2>
								{% set excerpt = article.body|striptags|slice(0,300) %}
								<p class="excerpt text-gray-800 font-serif text-base px-6 mt-1 mb-5">{{ excerpt }}...</p>
							</a>
						</div>
						<div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6">
							<div class="flex items-center justify-between">
								<p class="text-gray-500 text-xs md:text-sm">{{article.active_votes|length}} Upvotes - {{article.body|split(' ')|length }} Words</p>
							</div>
						</div>
					</article>
				{% if nbPosts == articles|length %}</div>{% endif %}
				{% endif %}
			{% endif %}
		{% endif %}
	{% endfor %}
	</div>
	
	<div class="text-center">
		<a href="https://peakd.com/@{{ settings.author }}" class="flex-1 p-1 mt-4 mb-2 md:mt-0 block md:inline-block appearance-none bg-green-500 text-white text-base font-semibold tracking-wider py-4 rounded shadow hover:bg-green-400">{{ settings.nextbutton }}</a>
	</div>
    
{% endblock %}

{% block scripts %}
<script>
  $(function() {
  	$(".excerpt").each(function (){
			text = $(this).text();
			text = text.replace(/!\[[^\]]*\]\((.*?)\s*("(?:.*[^"])")?\s*\)/g, '');
			text = marked(text);
			$(this).html(text);
		});
		
  	$("article").each(function (){
  		image = $(this).data('image').match(/!\[[^\]]*\]\((.*?)\s*("(?:.*[^"])")?\s*\)/g);
  		if (image === null) {
  			head = "/themes/{{ settings.theme }}/no-img.png"
  		} else {
  			head = image[0].slice(0,-1).match(/\bhttps?:\/\/\S+/gi);
  		}
  		img = $(this).find('.img-article');
  		img.attr('src', head);
  	});
  });
</script>
{% endblock %}
