{% extends "admin/admin-layout.html" %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
<style>
/* Thanks to Milligram CSS to force size for EasyMDE */
.editor-preview h1,h2,h3,h4,h5,h6 {
	font-family: sans-serif;
  font-weight: 300;
  letter-spacing: -.1rem;
  margin-bottom: 2.0rem;
  margin-top: 0;
}

.editor-preview h1 {font-size: 4.6rem;line-height: 1.2;}
.editor-preview h2 {font-size: 3.6rem;line-height: 1.25;}
.editor-preview h3 {font-size: 2.8rem;line-height: 1.3;}
.editor-preview h4 {font-size: 2.2rem;letter-spacing: -.08rem;line-height: 1.35;}
.editor-preview h5 {font-size: 1.8rem;letter-spacing: -.05rem;line-height: 1.5;}
.editor-preview h6 {font-size: 1.6rem;letter-spacing: 0;line-height: 1.4;}
.editor-preview a {text-decoration: underline;}
</style>
{% endblock %}

{% block content %}
<div class="w-full px-4 md:px-0 md:mt-8 mb-16 text-gray-100 leading-normal">
	<div class="flex flex-row flex-wrap flex-grow mt-2">
		<div class="w-full">
			<div class="bg-gray-800 border border-gray-800 rounded shadow p-1">
			  <div class="border-b border-gray-800 p-3">
			    <h3 class="font-bold uppercase text-gray-300">New Post</h3>
			  </div>

			  <div class="text-center text-red-500 p-2 mb-6 border-2 rounded border-red-400">
					<p>Don't forget : this post will be posted on Blockchain and cannot be deleted (but you can edit it)</p>
				</div>

			  <input id="postAuthor" type="hidden" value="{{ settings.author }}">

			  <div class="md:flex md:items-center mb-6">
					<div class="text-center md:w-1/4">
						<label class="block text-gray-300 font-bold mb-1 md:mb-0 pr-4" for="postTitle">
						  Title
						</label>
					</div>
					<div class="md:w-3/4">
						<input name="postTitle" id="postTitle" class="bg-gray-700 appearance-none border-2 border-gray-500 rounded w-3/4 py-2 px-4 text-gray-100 leading-tight focus:outline-none focus:bg-black focus:border-gray-500" type="text" placeholder="Make a great title for this post :)" {% if postTitle %}value="{{ postTitle }}"{% endif %}>
					</div>
				</div>

				<input type="file" name="imgupload" id="imgupload" style="display:none"/>
				<div class="border-2 upload-area text-center text-2xl p-6">
                <p id="uplText">Drag and Drop image here / Click to select image</p>
            </div>

			  <div class="w-full text-center mb-2">
			  	<label class="text-gray-300 font-bold" for="mde">
						  Post
					</label>
				</div>
				<div class="md:flex md:items-center mb-6">
			  	<div class="z-10 w-full bg-white text-black">
			  		<textarea id="mde" name="mde">{% if postContent %}{{ postContent }}{% endif %}</textarea>
					</div>
				</div>

				<div class="md:flex md:items-center mb-6">
					<div class="text-center md:w-1/4">
						<label class="block text-gray-300 font-bold mb-1 md:mb-0 pr-4" for="postTags">
						  Tags (separated by space)
						</label>
					</div>
					<div class="md:w-3/4">
						{% if postTags %}
						<span id="tag1">{{ postTags[0] }}</span> <input name="postTags" id="postTags" class="bg-gray-700 appearance-none border-2 border-gray-500 rounded w-3/4 py-2 px-4 text-gray-100 leading-tight focus:outline-none focus:bg-black focus:border-gray-500" type="text" placeholder="Find some tags" value="{% for tag in postTags %}{% if loop.index > 1 %}{{ tag }} {% endif %}{% endfor %}">
						{% else %}
						<input name="postTags" id="postTags" class="bg-gray-700 appearance-none border-2 border-gray-500 rounded w-3/4 py-2 px-4 text-gray-100 leading-tight focus:outline-none focus:bg-black focus:border-gray-500" type="text" placeholder="Find some tags">
						{% endif %}
					</div>
				</div>

				<div id="results" class="w-full text-center mb-6"></div>

				{% if postContent %}
				<div id="actions" class="w-full text-center">
					<button id="postUpdate" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 border border-blue-700 rounded">Update</button>
				</div>
				{% else %}
				<div id="actions" class="w-full text-center">
					<button id="postCreate" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 border border-blue-700 rounded">Create</button>
				</div>
				{% endif %}

			</div>
		</div>
	</div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<script src="https://bundle.run/buffer@6.0.3"></script>
<script>
	window.onload = function () {
		if (typeof hive_keychain === 'undefined') {
			$('#actions').addClass('text-red-400 mb-6').html('You don\'t have Hive Keychain please install it for <a target="_blank" href="https://chrome.google.com/webstore/detail/hive-keychain/jcacnejopjdphbnjgfaaobbfafkihpep">Brave/Chrome</a> or <a target="_blank" href="https://addons.mozilla.org/en-GB/firefox/addon/hive-keychain/">Firefox</a>')
		}
	}

	$(function() {
		var easyMDE = new EasyMDE({
			element: $('#mde')[0],
			autofocus: true,
			spellChecker: false,
			imageUpload: true,
			autosave: {
				enabled: true,
				unique_id: 'SuperHive_Draft'
			},
		});

		// Prevent redirect
		$("html").on("drop", function(e) { e.preventDefault(); e.stopPropagation(); });
		$("html").on("dragover", function(e) {
		  e.preventDefault();
		  e.stopPropagation();
		  $("#uplText").text("Drag here");
		});

		// Click to open upload window
			$(".upload-area").click(function(){
		      $("#imgupload").click();
		  });

		// Drag enter
		$('.upload-area').on('dragenter', function (e) {
		    e.stopPropagation();
		    e.preventDefault();
		    $("#uplText").text("Drop");
		});

		// Drag over
		$('.upload-area').on('dragover', function (e) {
		    e.stopPropagation();
		    e.preventDefault();
		    $("#uplText").text("Drop");
		});

		$('.upload-area').on('drop', function (e) {
		  e.stopPropagation();
		  e.preventDefault();

		  $("#uplText").text("Verify before image hosting...");
			file = e.originalEvent.dataTransfer.files;
			image = file[0];

			reader = new FileReader();
			reader.readAsBinaryString(image);
			reader.onload = function(e) {
		  	hive_keychain.requestHandshake(function() {
					account = '{{ settings.author }}';

					// Use Buffer from NodeJS to the browser to create message for Hive Keychain
					Buffer = new Uint32Array();
					data = buffer.Buffer.from(reader.result, 'binary');
					prefix = buffer.Buffer.from('ImageSigningChallenge');
		  		message = buffer.Buffer.concat([prefix, data]);

					// Sign this with Keychain
					hive_keychain.requestSignBuffer(
						account,
						JSON.stringify(message),
						'Posting',
						function (response) {
							if(response.result != null) {
								fd = new FormData();
								fd.append('file', image);
								url = 'https://images.hive.blog/'+account+'/'+response.result;
								$.ajax({
									url: url,
									data: fd,
									processData: false,
									contentType: false,
									type: 'POST',
									success: function(data){
										$("#uplText").text("Hosting OK ! You can upload another image :)");
										str = '![Legend of '+image.name+']('+data.url+')';
										insertString(easyMDE.codemirror,str);
									}
								});
							}
						},
						null,
						null
					);
				});
		  };

		});

		function insertString(editor,str){
			var selection = editor.getSelection();

		  if(selection.length>0){
		      editor.replaceSelection(str);
		  } else {
		    var doc = editor.getDoc();
		    var cursor = doc.getCursor();

		    var pos = {
		       line: cursor.line,
		       ch: cursor.ch
		    }

		    doc.replaceRange(str, pos);
		  }
		}

		{% if postPermlink %}
    $('#postUpdate').on('click tap', function(event) {
    	event.preventDefault();
    	account = $('#postAuthor').val();
			title = $('#postTitle').val();
			slug = "{{ postPermlink }}";
			body = easyMDE.value();
			tags = $('#tag1').text()+" "+$('#postTags').val();
			taglist = tags.split(' ');
			imageLinks = body.match(/!\[[^\]]*\]\((.*?)\s*("(?:.*[^"])")?\s*\)/g);
			if (imageLinks != null) {
				images = [];
				for (var i = 0; i < imageLinks.length; i++) {
					str = imageLinks[i].match(/\(http([^)]+)\)/g);
					images[i] = str[0].slice(1, -1)
				}
			} else images = ["{{ settings.social.image }}"];
			json_metadata = JSON.stringify({ tags: taglist, image: images, app: "SuperHive", format: "markdown" });
			console.log(json_metadata);
			hive_keychain.requestHandshake(function() {
				hive_keychain.requestPost(
					account,
					title,
					body,
					taglist[0],
					'',
					json_metadata,
					slug,
					"", // Comment_options TO DO
					function(response) {
						$('#results').text(response.message);
					}
				);
			});
    });
    {% else %}
    $('#postCreate').on('click tap', function(event) {
    	event.preventDefault();
    	account = $('#postAuthor').val();
			title = $('#postTitle').val();
			slug = title.toLowerCase().replace(/[^\w ]+/g,'').replace(/ +/g,'-')+'-'+Math.random().toString(36).substring(2);
			body = easyMDE.value();
			tags = $('#postTags').val();
			taglist = tags.split(' ');
			if (body.match(/!\[[^\]]*\]\((.*?)\s*("(?:.*[^"])")?\s*\)/g) != null) {
				imageLinks = body.match(/!\[[^\]]*\]\((.*?)\s*("(?:.*[^"])")?\s*\)/g);
				images = [];
				for (var i = 0; i < imageLinks.length; i++) {
					str = imageLinks[i].match(/\(http([^)]+)\)/g);
					images[i] = str[0].slice(1, -1)
				}
			} else images = ["{{ settings.social.image }}"];
			console.log(images);
			json_metadata = JSON.stringify({ tags: taglist, image: images, app: "SuperHive", format: "markdown" });
			hive_keychain.requestHandshake(function() {
				hive_keychain.requestPost(
					account,
					title,
					body,
					taglist[0],
					'',
					json_metadata,
					slug,
					"", // Comment_options TO DO
					function(response) {
						$('#results').text(response.message);
					}
				);
			});
    });
    {% endif %}
	});
</script>
{% endblock %}
